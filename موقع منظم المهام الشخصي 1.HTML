<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مُنظِّم المهام</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItmF2LPYqtik2YjZhiDYqtithdmK2YciLAogICJzaG9ydF9uYW1lIjogItiq2KfYsNinIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxMTE4MjciLAogICJ0aGVtZV9jb2xvciI6ICIjM2I4MmY2IiwKICAiZGVzY3JpcHRpb24iOiAi2LnZhNmK2LEg2YTZitmEINiq2KfYsNinINm22YbZitmEINiq2KfYudiqIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY8O / MTkyeDE5Mi80YTkwZTIvZmZmZmZmP3RleHQ9VGFza3MiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY8O / NTYyeDUxMi80YTkwZTIvZmZmZmZmP3RleHQ9VGFza3MiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIKICAgIH0KICBdCn0=">
    <meta name="theme-color" content="#4a90e2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="مُنظِّم المهام">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4a90e2/ffffff?text=Tasks">
    <style>
        :root {
            --primary-bg: #f3f4f6;
            --secondary-bg: #ffffff;
            --primary-text: #111827;
            --secondary-text: #4b5563;
            --accent-color: #3b82f6;
            --accent-text: #ffffff;
            --border-color: #e5e7eb;
            --danger-color: #ef4444;
        }

        .dark {
            --primary-bg: #111827;
            --secondary-bg: #1f2937;
            --primary-text: #f9fafb;
            --secondary-text: #9ca3af;
            --accent-color: #60a5fa;
            --accent-text: #1f2937;
            --border-color: #374151;
            --danger-color: #f87171;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--primary-text);
            font-family: 'Cairo', 'sans-serif';
            transition: background-color 0.3s, color 0.3s;
        }
        
        .bg-primary-bg { background-color: var(--primary-bg); }
        .bg-secondary-bg { background-color: var(--secondary-bg); }
        .text-primary-text { color: var(--primary-text); }
        .text-secondary-text { color: var(--secondary-text); }
        .bg-accent-color { background-color: var(--accent-color); }
        .text-accent-text { color: var(--accent-text); }
        .border-border-color { border-color: var(--border-color); }
        .text-danger-color { color: var(--danger-color); }
        .bg-danger-color { background-color: var(--danger-color); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--secondary-bg); }
        ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2563eb; }
        .dark ::-webkit-scrollbar-thumb { background: #93c5fd; }
        
        progress { accent-color: var(--accent-color); }

    </style>
</head>
<body class="antialiased">

    <!-- Main Container -->
    <div id="app-container" class="max-w-7xl mx-auto md:p-4">
        
        <!-- App Shell -->
        <div class="bg-secondary-bg md:rounded-2xl shadow-lg flex flex-col md:flex-row min-h-screen md:min-h-[calc(100vh-2rem)]">
            
            <!-- Sidebar / Navigation -->
            <nav class="bg-primary-bg/50 md:bg-secondary-bg border-b md:border-b-0 md:border-r border-border-color md:w-64 md:rounded-r-2xl">
                <div class="p-4 flex justify-between items-center">
                    <h1 class="text-xl font-bold text-accent-color flex items-center gap-2">
                        <i class="fas fa-check-double"></i>
                        <span>مُنظِّم المهام</span>
                    </h1>
                    <button id="mobile-menu-button" class="md:hidden text-2xl text-secondary-text">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <ul id="main-nav" class="hidden md:block p-2 space-y-1">
                    <li><a href="#" data-view="dashboard" class="nav-link active flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-accent-color hover:text-accent-text transition-colors"><i class="fas fa-tachometer-alt w-5 text-center"></i><span>لوحة التحكم</span></a></li>
                    <li><a href="#" data-view="tasks" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-accent-color hover:text-accent-text transition-colors"><i class="fas fa-tasks w-5 text-center"></i><span>إدارة المهام</span></a></li>
                    <li><a href="#" data-view="habits" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-accent-color hover:text-accent-text transition-colors"><i class="fas fa-sync-alt w-5 text-center"></i><span>متتبع العادات</span></a></li>
                    <li><a href="#" data-view="stats" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-accent-color hover:text-accent-text transition-colors"><i class="fas fa-chart-pie w-5 text-center"></i><span>الإحصائيات</span></a></li>
                    <li><a href="#" data-view="settings" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-accent-color hover:text-accent-text transition-colors"><i class="fas fa-cog w-5 text-center"></i><span>الإعدادات</span></a></li>
                </ul>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 p-4 md:p-6 overflow-y-auto">
                <div id="dashboard-view" class="view"></div>
                <div id="tasks-view" class="view hidden"></div>
                <div id="habits-view" class="view hidden"></div>
                <div id="stats-view" class="view hidden"></div>
                <div id="settings-view" class="view hidden"></div>
            </main>
        </div>
    </div>

    <!-- Modals and Overlays -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>
    <div id="main-modal" class="fixed inset-0 p-4 flex items-center justify-center hidden z-50">
        <div id="modal-content" class="bg-secondary-bg rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto"></div>
    </div>
    <div id="confirm-dialog" class="fixed inset-0 p-4 flex items-center justify-center hidden z-50">
        <div class="bg-secondary-bg rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <p id="confirm-message" class="mb-4 text-lg">هل أنت متأكد؟</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes" class="px-6 py-2 bg-danger-color text-white rounded-lg hover:bg-opacity-80">نعم</button>
                <button id="confirm-no" class="px-6 py-2 bg-gray-300 dark:bg-gray-600 text-primary-text rounded-lg hover:bg-opacity-80">لا</button>
            </div>
        </div>
    </div>
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
        <p id="toast-message">تم بنجاح!</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        const App = {
            state: {
                tasks: [],
                habits: [],
                categories: [
                    { id: 1, name: 'عمل', color: '#3b82f6', icon: 'fas fa-briefcase' },
                    { id: 2, name: 'شخصي', color: '#10b981', icon: 'fas fa-user' },
                    { id: 3, name: 'دراسة', color: '#f97316', icon: 'fas fa-graduation-cap' }
                ],
                settings: { theme: 'light' },
                activeView: 'dashboard',
                filter: { tasks: { query: '', priority: 'all', status: 'all' } }
            },
            
            // Runtime state for notifications, not saved to localStorage
            scheduledNotifications: {},

            init() {
                this.loadState();
                this.attachEventListeners();
                this.render();
                this.applyTheme();
                this.boundHabitClickHandler = this.handleHabitClick.bind(this);
                
                this.requestNotificationPermission();
                this.scheduleAllReminders();
            },

            // --- NOTIFICATION LOGIC ---
            requestNotificationPermission() {
                if (!("Notification" in window)) {
                    console.log("This browser does not support desktop notifications.");
                    return;
                }
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            this.showToast('تم تفعيل الإشعارات بنجاح!');
                        } else {
                            this.showToast('تم رفض إذن الإشعارات.', 'error');
                        }
                    });
                }
            },

            scheduleAllReminders() {
                this.state.tasks.forEach(task => {
                    if (!task.completed) {
                        this.scheduleRemindersForTask(task);
                    }
                });
            },
            
            cancelAllRemindersForTask(taskId) {
                if (this.scheduledNotifications[taskId]) {
                    this.scheduledNotifications[taskId].forEach(timeoutId => clearTimeout(timeoutId));
                    delete this.scheduledNotifications[taskId];
                }
            },

            scheduleRemindersForTask(task) {
                this.cancelAllRemindersForTask(task.id); 

                if (task.completed || !task.dueDate || !task.dueTime || !task.reminders || task.reminders.length === 0) {
                    return;
                }

                const dueDateTime = new Date(`${task.dueDate}T${task.dueTime}`);
                this.scheduledNotifications[task.id] = [];
                const now = new Date();

                task.reminders.forEach(reminder => {
                    let reminderDateTime = new Date(dueDateTime.getTime());
                    const value = parseInt(reminder.value, 10);
                    const unit = reminder.unit;
                    
                    if (isNaN(value)) return;

                    let reminderText = `تذكير: ${value} ${
                        {minutes: 'دقيقة', hours: 'ساعة', days: 'يوم', weeks: 'أسبوع'}[unit]
                    } قبل موعد "${task.title}"`;

                    switch (unit) {
                        case 'minutes': reminderDateTime.setMinutes(reminderDateTime.getMinutes() - value); break;
                        case 'hours':   reminderDateTime.setHours(reminderDateTime.getHours() - value);   break;
                        case 'days':    reminderDateTime.setDate(reminderDateTime.getDate() - value);     break;
                        case 'weeks':   reminderDateTime.setDate(reminderDateTime.getDate() - (value * 7)); break;
                    }

                    const delay = reminderDateTime.getTime() - now.getTime();

                    if (delay > 0) {
                        const timeoutId = setTimeout(() => {
                            if (Notification.permission === "granted") {
                                const notification = new Notification("اقترب موعد المهمة!", {
                                    body: reminderText,
                                    icon: "https://placehold.co/192x192/4a90e2/ffffff?text=Tasks",
                                    lang: 'ar',
                                    dir: 'rtl',
                                    vibrate: [200, 100, 200], // Vibration pattern
                                    silent: false // Explicitly request sound
                                });
                            }
                        }, delay);
                        this.scheduledNotifications[task.id].push(timeoutId);
                    }
                });
            },

            // --- CORE APP LOGIC ---
            loadState() {
                const savedState = localStorage.getItem('taskManagerData');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    this.state.tasks = parsedState.tasks || [];
                    this.state.habits = parsedState.habits || [];
                    this.state.categories = parsedState.categories || this.state.categories;
                    this.state.settings = parsedState.settings || this.state.settings;
                }
            },

            saveState() {
                localStorage.setItem('taskManagerData', JSON.stringify(this.state));
            },

            render() {
                document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                document.getElementById(`${this.state.activeView}-view`).classList.remove('hidden');

                document.querySelectorAll('.nav-link').forEach(l => {
                    l.classList.remove('active', 'bg-accent-color', 'text-accent-text');
                    if (l.dataset.view === this.state.activeView) {
                        l.classList.add('active', 'bg-accent-color', 'text-accent-text');
                    }
                });

                const renderView = `render${this.state.activeView.charAt(0).toUpperCase() + this.state.activeView.slice(1)}`;
                if (typeof this[renderView] === 'function') {
                    this[renderView]();
                }
            },

            attachEventListeners() {
                document.getElementById('main-nav').addEventListener('click', e => {
                    e.preventDefault();
                    const link = e.target.closest('.nav-link');
                    if (link) {
                        this.state.activeView = link.dataset.view;
                        this.render();
                        const nav = document.getElementById('main-nav');
                        if(!nav.classList.contains('md:block')) {
                            nav.classList.add('hidden');
                        }
                    }
                });

                document.getElementById('mobile-menu-button').addEventListener('click', () => {
                    document.getElementById('main-nav').classList.toggle('hidden');
                });
                
                document.getElementById('dashboard-view').addEventListener('click', e => {
                    const taskCheckbox = e.target.closest('.dashboard-task-item .task-checkbox');
                    if (taskCheckbox) {
                        const taskItem = taskCheckbox.closest('.dashboard-task-item');
                        const taskId = taskItem.dataset.taskId;
                        this.toggleTaskCompletion(taskId);
                        taskItem.remove();
                        return;
                    }

                    const habitItem = e.target.closest('.dashboard-habit-item');
                    if (!habitItem) return;
                    const habitId = habitItem.dataset.habitId;
                    const habitType = habitItem.dataset.habitType;
                    let updatedHabit = null;
                    const today = new Date().toISOString().split('T')[0];

                    if (habitType === 'counter') {
                        const btn = e.target.closest('.add-habit-log-btn-dash');
                        if (btn) {
                            const subHabitId = btn.dataset.subhabitId;
                            updatedHabit = this.logHabitTimestamp(habitId, subHabitId);
                        }
                    } else { // daily
                        if (e.target.closest('.subhabit-label')) {
                            updatedHabit = this.toggleSubHabit(habitId, e.target.closest('.subhabit-label').dataset.subhabitId);
                        } else if (e.target.closest('.complete-habit-label')) {
                            updatedHabit = this.toggleSimpleHabit(habitId);
                        }
                    }

                    if (updatedHabit) {
                        habitItem.outerHTML = this.renderDashboardHabitItem(updatedHabit, today);
                    }
                });
            },

            renderDashboard() {
                const view = document.getElementById('dashboard-view');
                const today = new Date().toISOString().split('T')[0];

                const allIncompleteTasks = this.state.tasks
                    .filter(t => !t.completed)
                    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                const allHabits = this.state.habits;

                view.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">لوحة التحكم</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-secondary-bg p-4 rounded-lg shadow">
                            <h3 class="font-bold text-lg mb-3">جميع المهام القادمة</h3>
                            <div class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                ${allIncompleteTasks.length > 0 ? allIncompleteTasks.map(task => this.renderDashboardTaskItem(task)).join('') : '<p class="text-secondary-text text-center py-4">لا توجد مهام قادمة. رائع!</p>'}
                            </div>
                        </div>
                        <div class="bg-secondary-bg p-4 rounded-lg shadow">
                            <h3 class="font-bold text-lg mb-3">جميع العادات اليومية</h3>
                            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                                ${allHabits.length > 0 ? allHabits.map(habit => this.renderDashboardHabitItem(habit, today)).join('') : '<p class="text-secondary-text text-center py-4">ليس لديك عادات لتتبعها بعد.</p>'}
                            </div>
                        </div>
                    </div>`;
            },

            renderDashboardTaskItem(task) {
                const priorityClasses = { high: 'border-r-4 border-red-500', medium: 'border-r-4 border-yellow-500', low: 'border-r-4 border-blue-500' };
                const dueTime = task.dueTime ? ` - ${new Date(`1970-01-01T${task.dueTime}`).toLocaleTimeString('ar-SA', { hour: 'numeric', minute: '2-digit' })}` : '';
                 return `
                    <div class="dashboard-task-item flex items-start gap-3 p-2 bg-primary-bg rounded-lg ${priorityClasses[task.priority] || ''}" data-task-id="${task.id}">
                        <input type="checkbox" class="task-checkbox mt-1 h-5 w-5 rounded text-accent-color focus:ring-accent-color">
                        <div class="flex-grow">
                             <p class="font-semibold">${task.title}</p>
                             <p class="text-xs text-secondary-text">الاستحقاق: ${task.dueDate}${dueTime}</p>
                        </div>
                    </div>
                 `;
            },

            renderDashboardHabitItem(habit, today) {
                if (habit.type === 'counter') {
                    const todayCount = (habit.log || [])
                        .filter(entry => new Date(entry.timestamp).toISOString().split('T')[0] === today)
                        .length;
                    
                    let completionControl;
                    if(habit.subHabits && habit.subHabits.length > 0) {
                        completionControl = `<div class="mt-2 space-y-1">
                            ${habit.subHabits.map(sh => `
                                <div class="flex items-center justify-between p-1.5 bg-secondary-bg/50 dark:bg-primary-bg/50 rounded-md">
                                    <span class="text-sm">${sh.title}</span>
                                    <button class="add-habit-log-btn-dash w-7 h-7 bg-accent-color text-accent-text rounded-full flex items-center justify-center text-lg font-light shadow hover:bg-opacity-80" data-subhabit-id="${sh.id}">+</button>
                                </div>
                            `).join('')}
                        </div>`;
                    } else {
                        completionControl = `<button class="add-habit-log-btn-dash w-10 h-10 bg-accent-color text-accent-text rounded-full flex items-center justify-center text-2xl font-light shadow hover:bg-opacity-80">+</button>`;
                    }

                    return `
                        <div class="dashboard-habit-item bg-primary-bg p-3 rounded-lg" data-habit-id="${habit.id}" data-habit-type="counter">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-semibold">${habit.title}</p>
                                    <p class="text-xs text-secondary-text">مرات اليوم: ${todayCount}</p>
                                </div>
                                ${habit.subHabits && habit.subHabits.length > 0 ? '' : completionControl}
                            </div>
                             ${habit.subHabits && habit.subHabits.length > 0 ? completionControl : ''}
                        </div>
                    `;
                }

                // Logic for 'daily' type habits
                const todayLog = habit.log ? habit.log[today] || {} : {};
                let completionControl;

                if (habit.subHabits && habit.subHabits.length > 0) {
                     completionControl = `<div class="mt-2 space-y-1">${habit.subHabits.map(sh => `
                        <label class="subhabit-label flex items-center gap-2 p-1 rounded-md hover:bg-primary-bg cursor-pointer" data-subhabit-id="${sh.id}">
                            <input type="checkbox" class="h-4 w-4 rounded text-accent-color focus:ring-accent-color" ${todayLog[sh.id] ? 'checked' : ''}>
                            <span class="text-sm ${todayLog[sh.id] ? 'line-through text-secondary-text' : ''}">${sh.title}</span>
                        </label>
                    `).join('')}</div>`;
                } else {
                     const isCompletedToday = todayLog[habit.id];
                     completionControl = `
                        <label class="complete-habit-label flex items-center gap-2 mt-2 p-2 rounded-md border border-border-color cursor-pointer hover:bg-primary-bg ${isCompletedToday ? 'bg-green-50 dark:bg-green-900/20' : ''}">
                            <input type="checkbox" class="complete-habit-checkbox h-5 w-5 rounded text-accent-color focus:ring-accent-color" ${isCompletedToday ? 'checked' : ''}>
                            <span class="text-sm ${isCompletedToday ? 'line-through text-secondary-text' : ''}">إنجاز اليوم</span>
                        </label>`;
                }

                return `
                    <div class="dashboard-habit-item bg-primary-bg p-2 rounded-lg" data-habit-id="${habit.id}" data-habit-type="daily">
                        <p class="font-semibold">${habit.title}</p>
                        ${completionControl}
                    </div>
                `;
            },

            renderTasks() {
                const view = document.getElementById('tasks-view');
                const filteredTasks = this.state.tasks.filter(task => {
                    const { query, priority, status } = this.state.filter.tasks;
                    const queryMatch = task.title.toLowerCase().includes(query.toLowerCase());
                    const priorityMatch = priority === 'all' || task.priority === priority;
                    const statusMatch = status === 'all' || (status === 'completed' && task.completed) || (status === 'incomplete' && !task.completed);
                    return queryMatch && priorityMatch && statusMatch;
                });

                const now = new Date();
                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                const weekEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (7 - now.getDay()));
                const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                const yearEnd = new Date(now.getFullYear(), 11, 31);
                const overdueTasks = filteredTasks.filter(t => !t.completed && new Date(t.dueDate) < todayEnd && t.dueDate < new Date().toISOString().split('T')[0]);
                const groups = {
                    overdue: overdueTasks,
                    daily: filteredTasks.filter(t => new Date(t.dueDate) <= todayEnd && !overdueTasks.includes(t)),
                    weekly: filteredTasks.filter(t => new Date(t.dueDate) > todayEnd && new Date(t.dueDate) <= weekEnd),
                    monthly: filteredTasks.filter(t => new Date(t.dueDate) > weekEnd && new Date(t.dueDate) <= monthEnd),
                    yearly: filteredTasks.filter(t => new Date(t.dueDate) > monthEnd && new Date(t.dueDate) <= yearEnd),
                    future: filteredTasks.filter(t => new Date(t.dueDate) > yearEnd)
                };
                
                view.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">إدارة المهام</h2>
                        <button id="add-task-btn" class="bg-accent-color text-accent-text px-4 py-2 rounded-lg hover:bg-opacity-80 transition-colors flex items-center gap-2"><i class="fas fa-plus"></i> إضافة مهمة</button>
                    </div>
                    <div class="flex flex-wrap gap-4 mb-6 bg-primary-bg p-4 rounded-lg">
                        <input type="text" id="task-search" placeholder="ابحث عن مهمة..." class="flex-grow bg-secondary-bg border border-border-color rounded-lg px-3 py-2 focus:ring-2 focus:ring-accent-color focus:outline-none" value="${this.state.filter.tasks.query}">
                        <select id="task-priority-filter" class="bg-secondary-bg border border-border-color rounded-lg px-3 py-2 focus:ring-2 focus:ring-accent-color focus:outline-none">
                            ${['all', 'high', 'medium', 'low'].map(p => `<option value="${p}" ${this.state.filter.tasks.priority === p ? 'selected' : ''}>${{all: 'كل الأولويات', high: 'هام', medium: 'متوسط', low: 'عادي'}[p]}</option>`).join('')}
                        </select>
                        <select id="task-status-filter" class="bg-secondary-bg border border-border-color rounded-lg px-3 py-2 focus:ring-2 focus:ring-accent-color focus:outline-none">
                            ${['all', 'incomplete', 'completed'].map(s => `<option value="${s}" ${this.state.filter.tasks.status === s ? 'selected' : ''}>${{all: 'كل الحالات', incomplete: 'غير مكتملة', completed: 'مكتملة'}[s]}</option>`).join('')}
                        </select>
                    </div>
                    ${Object.entries(groups).map(([key, tasks]) => this.renderTaskGroup(
                        {overdue: 'متأخرة', daily: 'اليوم', weekly: 'هذا الأسبوع', monthly: 'هذا الشهر', yearly: 'هذا العام', future: 'المستقبل'}[key],
                        tasks,
                        key === 'overdue' ? 'text-danger-color' : 'text-primary-text'
                    )).join('')}
                `;

                document.getElementById('add-task-btn').addEventListener('click', () => this.showTaskModal());
                document.getElementById('tasks-view').addEventListener('click', e => this.handleTaskClick(e));
                document.getElementById('task-search').addEventListener('input', e => { this.state.filter.tasks.query = e.target.value; this.renderTasks(); });
                document.getElementById('task-priority-filter').addEventListener('change', e => { this.state.filter.tasks.priority = e.target.value; this.renderTasks(); });
                document.getElementById('task-status-filter').addEventListener('change', e => { this.state.filter.tasks.status = e.target.value; this.renderTasks(); });
            },

            renderTaskGroup(title, tasks, titleColor) {
                if (tasks.length === 0) return '';
                return `<div class="mb-6"><h3 class="font-bold text-lg mb-2 ${titleColor}">${title} (${tasks.length})</h3><div class="space-y-3">${tasks.map(task => this.renderTaskItem(task)).join('')}</div></div>`;
            },

            renderTaskItem(task) {
                const category = this.state.categories.find(c => c.id === task.categoryId) || { name: 'غير مصنف', color: '#888', icon: 'fas fa-question-circle' };
                const priorityClasses = { high: 'border-r-4 border-red-500', medium: 'border-r-4 border-yellow-500', low: 'border-r-4 border-blue-500' };
                const completedSubtasks = task.subtasks.filter(st => st.completed).length;
                const progress = task.subtasks.length > 0 ? (completedSubtasks / task.subtasks.length) * 100 : (task.completed ? 100 : 0);
                const dueTime = task.dueTime ? ` - ${new Date(`1970-01-01T${task.dueTime}`).toLocaleTimeString('ar-SA', { hour: 'numeric', minute: '2-digit' })}` : '';
                return `
                    <div class="task-item bg-secondary-bg p-3 rounded-lg shadow-sm flex flex-col gap-2 transition-all hover:shadow-md ${priorityClasses[task.priority] || ''} ${task.completed ? 'opacity-50' : ''}" data-task-id="${task.id}">
                        <div class="flex items-start gap-4">
                            <input type="checkbox" class="task-checkbox mt-1.5 h-5 w-5 rounded text-accent-color focus:ring-accent-color" ${task.completed ? 'checked' : ''}>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <span class="${task.completed ? 'line-through' : ''}">${task.title}</span>
                                    <div class="flex items-center gap-3 text-secondary-text">
                                        <span class="text-xs px-2 py-1 rounded" style="background-color: ${category.color}; color: white;"><i class="${category.icon}"></i> ${category.name}</span>
                                        <button class="edit-task-btn text-sm hover:text-accent-color"><i class="fas fa-edit"></i></button>
                                        <button class="delete-task-btn text-sm hover:text-danger-color"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <p class="text-xs text-secondary-text mt-1">تاريخ الاستحقاق: ${task.dueDate}${dueTime}</p>
                                ${task.subtasks.length > 0 ? `<div class="mt-2"><progress class="w-full h-1.5 rounded-full" value="${progress}" max="100"></progress><p class="text-xs text-secondary-text">${completedSubtasks} / ${task.subtasks.length} مهام فرعية</p></div>` : ''}
                            </div>
                        </div>
                        ${task.subtasks.length > 0 ? `
                        <div class="pr-8 pl-4 pt-2 border-t border-border-color">
                            ${task.subtasks.map(st => `
                                <label class="flex items-center gap-3 p-1 rounded hover:bg-primary-bg cursor-pointer" data-subtask-id="${st.id}">
                                    <input type="checkbox" class="subtask-checkbox h-4 w-4 rounded text-accent-color focus:ring-accent-color" ${st.completed ? 'checked' : ''}>
                                    <span class="text-sm ${st.completed ? 'line-through text-secondary-text' : ''}">${st.title}</span>
                                </label>
                            `).join('')}
                        </div>` : ''}
                    </div>`;
            },
            
            handleTaskClick(e) {
                const taskItem = e.target.closest('.task-item');
                if (!taskItem) return;
                const taskId = taskItem.dataset.taskId;
                let updatedTask = null;

                if (e.target.classList.contains('task-checkbox')) {
                    updatedTask = this.toggleTaskCompletion(taskId);
                } else if (e.target.closest('.edit-task-btn')) {
                    this.showTaskModal(taskId);
                } else if (e.target.closest('.delete-task-btn')) {
                    this.showConfirmation('هل أنت متأكد من حذف هذه المهمة؟', () => this.deleteTask(taskId));
                } else if (e.target.classList.contains('subtask-checkbox')) {
                    const subtaskId = e.target.closest('[data-subtask-id]').dataset.subtaskId;
                    updatedTask = this.toggleSubtaskCompletion(taskId, subtaskId);
                }

                if (updatedTask) {
                    if (this.state.filter.tasks.status !== 'all') {
                        this.renderTasks();
                    } else {
                        taskItem.outerHTML = this.renderTaskItem(updatedTask);
                    }
                }
            },
            
            showTaskModal(taskId = null) {
                const task = taskId ? this.state.tasks.find(t => t.id === taskId) : null;
                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = `
                    <form id="task-form" class="p-6 space-y-4">
                        <h3 class="text-xl font-bold">${task ? 'تعديل المهمة' : 'مهمة جديدة'}</h3>
                        <input type="hidden" name="id" value="${task?.id || ''}">
                        <div><label class="block text-sm font-medium text-secondary-text">عنوان المهمة</label><input type="text" name="title" class="mt-1 block w-full bg-primary-bg border border-border-color rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-accent-color focus:border-accent-color" value="${task?.title || ''}" required></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-secondary-text">تاريخ الاستحقاق</label><input type="date" name="dueDate" class="mt-1 block w-full bg-primary-bg border border-border-color rounded-md shadow-sm py-2 px-3" value="${task?.dueDate || new Date().toISOString().split('T')[0]}" required></div>
                            <div><label class="block text-sm font-medium text-secondary-text">وقت الاستحقاق</label><input type="time" name="dueTime" class="mt-1 block w-full bg-primary-bg border border-border-color rounded-md shadow-sm py-2 px-3" value="${task?.dueTime || ''}" required></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-secondary-text">الأولوية</label><select name="priority" class="mt-1 block w-full bg-primary-bg border border-border-color rounded-md shadow-sm py-2 px-3">${['low', 'medium', 'high'].map(p => `<option value="${p}" ${task?.priority === p ? 'selected' : ''}>${{low: 'عادي', medium: 'متوسط', high: 'هام'}[p]}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-secondary-text">الفئة</label><select name="categoryId" class="mt-1 block w-full bg-primary-bg border border-border-color rounded-md shadow-sm py-2 px-3">${this.state.categories.map(c => `<option value="${c.id}" ${task?.categoryId == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select></div>
                        </div>
                        <div><label class="block text-sm font-medium text-secondary-text">ملاحظات</label><textarea name="notes" rows="2" class="mt-1 block w-full bg-primary-bg border border-border-color rounded-md shadow-sm py-2 px-3">${task?.notes || ''}</textarea></div>
                        <div>
                            <label class="block text-sm font-medium text-secondary-text">مهام فرعية</label>
                            <div id="subtasks-container" class="space-y-2 mt-1">${(task?.subtasks || []).map(st => this.renderSubtaskInput(st)).join('')}</div>
                            <button type="button" id="add-subtask-btn" class="text-sm text-accent-color mt-2"><i class="fas fa-plus"></i> إضافة مهمة فرعية</button>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-secondary-text">التذكيرات</label>
                            <div id="reminders-container" class="space-y-2 mt-1">${(task?.reminders || []).map(r => this.renderReminderInput(r)).join('')}</div>
                            <button type="button" id="add-reminder-btn" class="text-sm text-accent-color mt-2"><i class="fas fa-bell"></i> إضافة تذكير</button>
                        </div>
                        <div class="flex justify-end gap-3 pt-4 border-t border-border-color">
                            <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">إلغاء</button>
                            <button type="submit" class="px-4 py-2 bg-accent-color text-accent-text rounded-lg">حفظ</button>
                        </div>
                    </form>`;
                this.showModal();

                document.getElementById('add-subtask-btn').addEventListener('click', () => { document.getElementById('subtasks-container').insertAdjacentHTML('beforeend', this.renderSubtaskInput()); });
                document.getElementById('subtasks-container').addEventListener('click', e => { if (e.target.closest('.remove-subtask-btn')) e.target.closest('.subtask-input-group').remove(); });
                
                document.getElementById('add-reminder-btn').addEventListener('click', () => { document.getElementById('reminders-container').insertAdjacentHTML('beforeend', this.renderReminderInput()); });
                document.getElementById('reminders-container').addEventListener('click', e => { if (e.target.closest('.remove-reminder-btn')) e.target.closest('.reminder-input-group').remove(); });
                
                document.getElementById('task-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const taskData = Object.fromEntries(formData.entries());
                    
                    taskData.subtasks = Array.from(document.querySelectorAll('.subtask-input-group')).map(group => ({
                        id: group.dataset.subtaskId || Date.now() + Math.random(),
                        title: group.querySelector('input[name="subtask-title"]').value,
                        completed: group.querySelector('input[type="checkbox"]').checked
                    })).filter(st => st.title);

                    taskData.reminders = Array.from(document.querySelectorAll('.reminder-input-group')).map(group => ({
                        id: group.dataset.reminderId || Date.now() + Math.random(),
                        value: group.querySelector('input[name="reminder-value"]').value,
                        unit: group.querySelector('select[name="reminder-unit"]').value
                    })).filter(r => r.value);

                    if (taskData.id) this.updateTask(taskData); else this.createTask(taskData);
                    this.hideModal();
                });
            },

            renderSubtaskInput(subtask = { id: '', title: '', completed: false }) {
                return `
                <div class="subtask-input-group flex items-center gap-2" data-subtask-id="${subtask.id}">
                    <input type="checkbox" class="h-5 w-5 rounded text-accent-color focus:ring-accent-color" ${subtask.completed ? 'checked' : ''}>
                    <input type="text" name="subtask-title" class="flex-grow bg-primary-bg border-b border-border-color focus:outline-none" placeholder="مهمة فرعية..." value="${subtask.title}">
                    <button type="button" class="remove-subtask-btn text-danger-color"><i class="fas fa-times"></i></button>
                </div>`;
            },
            
            renderReminderInput(reminder = { id: '', value: '10', unit: 'minutes' }) {
                return `
                <div class="reminder-input-group flex items-center gap-2" data-reminder-id="${reminder.id}">
                    <span class="text-sm">تذكير قبل</span>
                    <input type="number" name="reminder-value" min="1" class="w-16 bg-primary-bg border-b border-border-color focus:outline-none text-center" value="${reminder.value}">
                    <select name="reminder-unit" class="bg-primary-bg border-b border-border-color focus:outline-none">
                        <option value="minutes" ${reminder.unit === 'minutes' ? 'selected' : ''}>دقيقة</option>
                        <option value="hours" ${reminder.unit === 'hours' ? 'selected' : ''}>ساعة</option>
                        <option value="days" ${reminder.unit === 'days' ? 'selected' : ''}>يوم</option>
                        <option value="weeks" ${reminder.unit === 'weeks' ? 'selected' : ''}>أسبوع</option>
                    </select>
                    <button type="button" class="remove-reminder-btn text-danger-color ml-auto"><i class="fas fa-times"></i></button>
                </div>`;
            },

            createTask(data) {
                const newTask = {
                    id: Date.now().toString(),
                    ...data,
                    categoryId: parseInt(data.categoryId),
                    completed: false, 
                    completionDate: null
                };
                this.state.tasks.push(newTask);
                this.scheduleRemindersForTask(newTask);
                this.saveState(); this.renderTasks(); this.showToast('تمت إضافة المهمة بنجاح.');
            },
            
            updateTask(data) {
                const taskIndex = this.state.tasks.findIndex(t => t.id === data.id);
                if (taskIndex > -1) {
                    this.state.tasks[taskIndex] = { ...this.state.tasks[taskIndex], ...data, categoryId: parseInt(data.categoryId) };
                    this.scheduleRemindersForTask(this.state.tasks[taskIndex]);
                    this.saveState(); this.renderTasks(); this.showToast('تم تحديث المهمة بنجاح.');
                }
            },

            deleteTask(taskId) {
                this.cancelAllRemindersForTask(taskId);
                this.state.tasks = this.state.tasks.filter(t => t.id !== taskId);
                this.saveState(); this.renderTasks(); this.showToast('تم حذف المهمة.');
            },

            toggleTaskCompletion(taskId) {
                const task = this.state.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    task.completionDate = task.completed ? new Date().toISOString().split('T')[0] : null;
                    task.subtasks.forEach(st => st.completed = task.completed);
                    
                    if (task.completed) {
                        this.cancelAllRemindersForTask(task.id);
                    } else {
                        this.scheduleRemindersForTask(task);
                    }
                    
                    this.saveState();
                    return task;
                }
                return null;
            },
            
            toggleSubtaskCompletion(taskId, subtaskId) {
                const task = this.state.tasks.find(t => t.id === taskId);
                if (task) {
                    const subtask = task.subtasks.find(st => st.id.toString() === subtaskId);
                    if(subtask) subtask.completed = !subtask.completed;
                    const allSubtasksCompleted = task.subtasks.every(st => st.completed);
                    if (task.completed !== allSubtasksCompleted) {
                        task.completed = allSubtasksCompleted;
                        if (task.completed) {
                           task.completionDate = new Date().toISOString().split('T')[0];
                           this.cancelAllRemindersForTask(task.id);
                        } else {
                           task.completionDate = null;
                           this.scheduleRemindersForTask(task);
                        }
                    }
                    this.saveState();
                    return task;
                }
                return null;
            },

            renderHabits() {
                const view = document.getElementById('habits-view');
                view.innerHTML = `
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">متتبع العادات</h2>
                        <button id="add-habit-btn" class="bg-accent-color text-accent-text px-4 py-2 rounded-lg hover:bg-opacity-80 transition-colors flex items-center gap-2"><i class="fas fa-plus"></i> إضافة عادة</button>
                    </div>
                    <div class="space-y-4">
                        ${this.state.habits.length > 0 ? this.state.habits.map(habit => 
                            habit.type === 'counter' ? this.renderCounterHabitItem(habit) : this.renderDailyHabitItem(habit)
                        ).join('') : '<p class="text-secondary-text text-center py-8">ليس لديك عادات لتتبعها بعد. ابدأ بإضافة واحدة!</p>'}
                    </div>`;
                document.getElementById('add-habit-btn').addEventListener('click', () => this.showHabitModal());
                const habitsView = document.getElementById('habits-view');
                habitsView.removeEventListener('click', this.boundHabitClickHandler);
                habitsView.removeEventListener('change', this.boundHabitClickHandler);
                habitsView.addEventListener('click', this.boundHabitClickHandler);
                habitsView.addEventListener('change', this.boundHabitClickHandler);
            },
            
            renderDailyHabitItem(habit) {
                const today = new Date().toISOString().split('T')[0];
                const todayLog = habit.log ? habit.log[today] || {} : {};
                const completedSubHabits = habit.subHabits.filter(sh => todayLog[sh.id]).length;
                const progress = habit.subHabits.length > 0 ? (completedSubHabits / habit.subHabits.length) * 100 : (todayLog[habit.id] ? 100 : 0);
                const totalCompletions = Object.values(habit.log || {}).reduce((sum, dayLog) => sum + Object.keys(dayLog).length, 0);

                let completionControl;
                if (habit.subHabits.length > 0) {
                    completionControl = `<div class="space-y-2 pt-3 border-t border-border-color mt-3">${habit.subHabits.map(sh => `
                        <label class="subhabit-label flex items-center gap-3 p-1.5 rounded-lg hover:bg-primary-bg cursor-pointer" data-subhabit-id="${sh.id}">
                            <input type="checkbox" class="h-4 w-4 rounded text-accent-color focus:ring-accent-color" ${todayLog[sh.id] ? 'checked' : ''}>
                            <span class="text-sm ${todayLog[sh.id] ? 'line-through text-secondary-text' : ''}">${sh.title}</span>
                        </label>
                    `).join('')}</div>`;
                } else {
                    const isCompletedToday = todayLog[habit.id];
                    completionControl = `
                        <label class="complete-habit-label flex items-center gap-3 p-3 mt-3 rounded-lg border border-border-color cursor-pointer hover:bg-primary-bg transition-colors ${isCompletedToday ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-700' : ''}">
                            <input type="checkbox" class="complete-habit-checkbox h-5 w-5 rounded text-accent-color focus:ring-accent-color" ${isCompletedToday ? 'checked' : ''}>
                            <span class="font-medium ${isCompletedToday ? 'line-through text-secondary-text' : ''}">إنجاز العادة اليوم</span>
                        </label>`;
                }

                return `
                <div class="habit-item bg-secondary-bg p-4 rounded-lg shadow-sm" data-habit-id="${habit.id}" data-habit-type="daily">
                    <div class="flex justify-between items-start mb-3">
                        <div><h3 class="font-bold text-lg">${habit.title}</h3><p class="text-sm text-secondary-text">${habit.description}</p></div>
                        <div class="flex items-center gap-3 text-secondary-text">
                            <button class="edit-habit-btn text-sm hover:text-accent-color"><i class="fas fa-edit"></i></button>
                            <button class="delete-habit-btn text-sm hover:text-danger-color"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="mb-1">
                        <div class="flex justify-between text-sm mb-1"><span>تقدم اليوم</span><span>${Math.round(progress)}%</span></div>
                        <div class="w-full bg-primary-bg rounded-full h-2.5"><div class="bg-accent-color h-2.5 rounded-full" style="width: ${progress}%"></div></div>
                    </div>
                    ${completionControl}
                    <p class="text-xs text-secondary-text mt-3 text-left">إجمالي الإنجازات: ${totalCompletions}</p>
                </div>`;
            },
            
            renderCounterHabitItem(habit, filter = 'this-month') {
                const logEntries = (habit.log || []).map(entry => ({ 
                    date: new Date(entry.timestamp), 
                    subHabitId: entry.subHabitId 
                }));
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1)); // Adjust for week starting on Monday
                startOfWeek.setHours(0, 0, 0, 0);
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

                let filteredTimestamps = [];
                let title = "";
                
                if (filter === 'this-week') {
                    title = "هذا الأسبوع";
                    filteredTimestamps = logEntries.filter(t => t.date >= startOfWeek);
                } else if (filter === 'this-month') {
                    title = "هذا الشهر";
                    filteredTimestamps = logEntries.filter(t => t.date >= startOfMonth);
                } else if (filter === 'all-time') {
                    title = "كل الأوقات";
                    filteredTimestamps = logEntries;
                } else {
                    const [year, month] = filter.split('-').map(Number);
                    const start = new Date(year, month - 1, 1);
                    const end = new Date(year, month, 1);
                    const monthNames = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
                    title = `${monthNames[month - 1]} ${year}`;
                    filteredTimestamps = logEntries.filter(t => t.date >= start && t.date < end);
                }

                const totalCount = filteredTimestamps.length;
                const countThisWeek = logEntries.filter(t => t.date >= startOfWeek).length;
                const countThisMonth = logEntries.filter(t => t.date >= startOfMonth).length;

                const monthOptions = new Set();
                logEntries.forEach(t => {
                    monthOptions.add(`${t.date.getFullYear()}-${String(t.date.getMonth() + 1).padStart(2, '0')}`);
                });
                
                const sortedMonthOptions = Array.from(monthOptions).sort().reverse();
                const monthNames = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];

                 let mainContent;
                if (habit.subHabits && habit.subHabits.length > 0) {
                    mainContent = `
                    <div class="col-span-1 md:col-span-2 space-y-3">
                        ${habit.subHabits.map(sh => {
                            const subHabitTotalCount = logEntries.filter(entry => entry.subHabitId === sh.id).length;
                            return `
                            <div class="flex justify-between items-center p-3 bg-primary-bg rounded-lg">
                                <div>
                                    <p class="font-semibold">${sh.title}</p>
                                    <p class="text-xs text-secondary-text">إجمالي المرات: ${subHabitTotalCount}</p>
                                </div>
                                <button class="add-habit-log-btn w-12 h-12 bg-accent-color text-accent-text rounded-full flex items-center justify-center text-3xl font-light shadow-lg hover:bg-opacity-80 transition-transform transform hover:scale-105" data-subhabit-id="${sh.id}">+</button>
                            </div>
                            `
                        }).join('')}
                    </div>
                    `;
                } else {
                    mainContent = `
                    <div class="flex justify-center">
                        <button class="add-habit-log-btn w-24 h-24 bg-accent-color text-accent-text rounded-full flex items-center justify-center text-5xl font-light shadow-lg hover:bg-opacity-80 transition-transform transform hover:scale-105">+</button>
                    </div>
                    <div class="text-center md:text-right space-y-2">
                        <div class="p-2 bg-primary-bg rounded-md"><p class="text-sm text-secondary-text">هذا الأسبوع</p><p class="text-2xl font-bold">${countThisWeek}</p></div>
                        <div class="p-2 bg-primary-bg rounded-md"><p class="text-sm text-secondary-text">هذا الشهر</p><p class="text-2xl font-bold">${countThisMonth}</p></div>
                        <div class="p-2 bg-primary-bg rounded-md"><p class="text-sm text-secondary-text">إجمالي المرات</p><p class="text-2xl font-bold">${(habit.log || []).length}</p></div>
                    </div>
                    `;
                }

                return `
                <div class="habit-item bg-secondary-bg p-4 rounded-lg shadow-sm" data-habit-id="${habit.id}" data-habit-type="counter" data-filter="${filter}">
                    <div class="flex justify-between items-start">
                        <div><h3 class="font-bold text-lg">${habit.title}</h3><p class="text-sm text-secondary-text">${habit.description}</p></div>
                        <div class="flex items-center gap-3 text-secondary-text">
                            <button class="edit-habit-btn text-sm hover:text-accent-color"><i class="fas fa-edit"></i></button>
                            <button class="delete-habit-btn text-sm hover:text-danger-color"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                        ${mainContent}
                    </div>
                    <div class="mt-6 pt-4 border-t border-border-color">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold">السجل (${title}: ${totalCount})</h4>
                            <select class="habit-filter-select bg-primary-bg border border-border-color rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-accent-color focus:outline-none">
                                <option value="this-month" ${filter === 'this-month' ? 'selected' : ''}>هذا الشهر</option>
                                <option value="this-week" ${filter === 'this-week' ? 'selected' : ''}>هذا الأسبوع</option>
                                <option value="all-time" ${filter === 'all-time' ? 'selected' : ''}>كل الأوقات</option>
                                <optgroup label="أشهر أخرى">
                                    ${sortedMonthOptions.map(m => `<option value="${m}" ${filter === m ? 'selected' : ''}>${monthNames[parseInt(m.split('-')[1])-1]} ${m.split('-')[0]}</option>`).join('')}
                                </optgroup>
                            </select>
                        </div>
                        <div class="history-log max-h-48 overflow-y-auto space-y-1 pr-2">
                            ${filteredTimestamps.length > 0 ? filteredTimestamps.sort((a,b) => b.date - a.date).map(entry => {
                                const subHabit = habit.subHabits.find(sh => sh.id === entry.subHabitId);
                                const subHabitTitle = subHabit ? `<span class="font-semibold text-accent-color/80"> - ${subHabit.title}</span>` : '';
                                return `<p class="text-sm text-secondary-text p-1.5 bg-primary-bg rounded-md">${entry.date.toLocaleString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: '2-digit' })}${subHabitTitle}</p>`
                            }).join('') : '<p class="text-sm text-secondary-text text-center py-4">لا يوجد سجل لهذه الفترة.</p>'}
                        </div>
                    </div>
                </div>`;
            },
            
            handleHabitClick(e) {
                const habitItem = e.target.closest('.habit-item');
                if (!habitItem) return;
                const habitId = habitItem.dataset.habitId;
                const habitType = habitItem.dataset.habitType;
                let updatedHabit = null;

                if (habitType === 'daily') {
                    if (e.target.closest('.subhabit-label')) {
                        updatedHabit = this.toggleSubHabit(habitId, e.target.closest('.subhabit-label').dataset.subhabitId);
                    } else if (e.target.closest('.complete-habit-label')) {
                        updatedHabit = this.toggleSimpleHabit(habitId);
                    }
                } else if (habitType === 'counter') {
                    const btn = e.target.closest('.add-habit-log-btn');
                    if (btn) {
                        const subHabitId = btn.dataset.subhabitId;
                        updatedHabit = this.logHabitTimestamp(habitId, subHabitId);
                    } else if (e.target.matches('.habit-filter-select')) {
                        const newFilter = e.target.value;
                        const habit = this.state.habits.find(h => h.id === habitId);
                        if (habit) habitItem.outerHTML = this.renderCounterHabitItem(habit, newFilter);
                        return;
                    }
                }

                if (e.target.closest('.edit-habit-btn')) {
                    this.showHabitModal(habitId);
                } else if (e.target.closest('.delete-habit-btn')) {
                    this.showConfirmation('هل أنت متأكد من حذف هذه العادة وكل سجلها؟', () => this.deleteHabit(habitId));
                }

                if (updatedHabit) {
                    const currentFilter = habitItem.dataset.filter;
                    habitItem.outerHTML = habitType === 'counter' 
                        ? this.renderCounterHabitItem(updatedHabit, currentFilter) 
                        : this.renderDailyHabitItem(updatedHabit);
                }
            },
            
            logHabitTimestamp(habitId, subHabitId = null) {
                const habit = this.state.habits.find(h => h.id === habitId);
                if (habit && habit.type === 'counter') {
                    if (!Array.isArray(habit.log)) habit.log = [];
                    if (habit.subHabits && habit.subHabits.length > 0 && !subHabitId) {
                        console.warn("Subhabit ID is required for this counter habit.");
                        return null;
                    }
                    habit.log.push({ 
                        timestamp: new Date().toISOString(), 
                        subHabitId: subHabitId || habit.id 
                    });
                    this.saveState();
                    return habit;
                }
                return null;
            },

            showHabitModal(habitId = null) {
                const habit = habitId ? this.state.habits.find(h => h.id === habitId) : null;
                const modalContent = document.getElementById('modal-content');
                 modalContent.innerHTML = `
                    <form id="habit-form" class="p-6 space-y-4">
                        <h3 class="text-xl font-bold">${habit ? 'تعديل العادة' : 'عادة جديدة'}</h3>
                        <input type="hidden" name="id" value="${habit?.id || ''}">
                        
                        <div>
                            <label class="block text-sm font-medium text-secondary-text">نوع العادة</label>
                            <div class="mt-2 grid grid-cols-2 gap-3">
                                <label class="flex items-center justify-center p-3 bg-primary-bg border border-border-color rounded-lg cursor-pointer has-[:checked]:bg-accent-color has-[:checked]:text-accent-text has-[:checked]:border-accent-color"><input type="radio" name="type" value="daily" class="sr-only" ${(!habit || habit.type === 'daily') ? 'checked' : ''}><span class="text-sm font-medium">إنجاز يومي</span></label>
                                <label class="flex items-center justify-center p-3 bg-primary-bg border border-border-color rounded-lg cursor-pointer has-[:checked]:bg-accent-color has-[:checked]:text-accent-text has-[:checked]:border-accent-color"><input type="radio" name="type" value="counter" class="sr-only" ${habit?.type === 'counter' ? 'checked' : ''}><span class="text-sm font-medium">عداد (+)</span></label>
                            </div>
                        </div>

                        <div><label class="block text-sm font-medium text-secondary-text">عنوان العادة</label><input type="text" name="title" class="mt-1 block w-full bg-primary-bg border border-border-color rounded-md shadow-sm py-2 px-3" value="${habit?.title || ''}" required></div>
                        <div><label class="block text-sm font-medium text-secondary-text">الوصف</label><textarea name="description" rows="2" class="mt-1 block w-full bg-primary-bg border border-border-color rounded-md shadow-sm py-2 px-3">${habit?.description || ''}</textarea></div>
                        
                        <div id="subhabits-section">
                            <label class="block text-sm font-medium text-secondary-text">العادات الفرعية (اختياري)</label>
                            <div id="subhabits-container" class="space-y-2 mt-1">${(habit?.subHabits || []).map(sh => this.renderSubHabitInput(sh)).join('')}</div>
                            <button type="button" id="add-subhabit-btn" class="text-sm text-accent-color mt-2"><i class="fas fa-plus"></i> إضافة عادة فرعية</button>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg">إلغاء</button>
                            <button type="submit" class="px-4 py-2 bg-accent-color text-accent-text rounded-lg">حفظ</button>
                        </div>
                    </form>`;
                this.showModal();
                document.getElementById('add-subhabit-btn').addEventListener('click', () => { document.getElementById('subhabits-container').insertAdjacentHTML('beforeend', this.renderSubHabitInput()); });
                document.getElementById('subhabits-container').addEventListener('click', e => { if (e.target.closest('.remove-subhabit-btn')) e.target.closest('.subhabit-input-group').remove(); });
                document.getElementById('habit-form').addEventListener('submit', e => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const habitData = Object.fromEntries(formData.entries());
                    habitData.subHabits = Array.from(document.querySelectorAll('.subhabit-input-group')).map(group => ({
                        id: group.dataset.subhabitId || (Date.now() + Math.random()).toString(),
                        title: group.querySelector('input[name="subhabit-title"]').value
                    })).filter(sh => sh.title);
                    if (habitData.id) this.updateHabit(habitData); else this.createHabit(habitData);
                    this.hideModal();
                });
            },

            renderSubHabitInput(subhabit = { id: '', title: '' }) {
                return `<div class="subhabit-input-group flex items-center gap-2" data-subhabit-id="${subhabit.id}"><input type="text" name="subhabit-title" class="flex-grow bg-primary-bg border-b border-border-color focus:outline-none" placeholder="عادة فرعية..." value="${subhabit.title}"><button type="button" class="remove-subhabit-btn text-danger-color"><i class="fas fa-times"></i></button></div>`;
            },

            createHabit(data) {
                const habitType = data.type;
                const newHabit = { 
                    id: Date.now().toString(), title: data.title, description: data.description, type: habitType,
                    subHabits: data.subHabits || [], 
                    log: habitType === 'daily' ? {} : [] 
                };
                this.state.habits.push(newHabit);
                this.saveState(); this.renderHabits(); this.showToast('تمت إضافة العادة بنجاح.');
            },
            
            updateHabit(data) {
                const habitIndex = this.state.habits.findIndex(h => h.id === data.id);
                if (habitIndex > -1) {
                    const habitType = data.type;
                    const oldHabit = this.state.habits[habitIndex];
                    this.state.habits[habitIndex] = { 
                        ...oldHabit, 
                        title: data.title, 
                        description: data.description, 
                        type: habitType,
                        subHabits: data.subHabits,
                        log: oldHabit.type === habitType ? oldHabit.log : (habitType === 'daily' ? {} : [])
                    };
                    this.saveState(); this.renderHabits(); this.showToast('تم تحديث العادة بنجاح.');
                }
            },

            deleteHabit(habitId) {
                this.state.habits = this.state.habits.filter(h => h.id !== habitId);
                this.saveState(); this.renderHabits(); this.showToast('تم حذف العادة.');
            },
            
            toggleSubHabit(habitId, subHabitId) {
                const habit = this.state.habits.find(h => h.id === habitId);
                if (!habit) return null;
                const today = new Date().toISOString().split('T')[0];
                if (typeof habit.log !== 'object' || Array.isArray(habit.log)) habit.log = {};
                if (!habit.log[today]) habit.log[today] = {};
                if (habit.log[today][subHabitId]) delete habit.log[today][subHabitId]; else habit.log[today][subHabitId] = true;
                this.saveState();
                return habit;
            },
            
            toggleSimpleHabit(habitId) {
                const habit = this.state.habits.find(h => h.id === habitId);
                if (!habit) return null;
                const today = new Date().toISOString().split('T')[0];
                if (typeof habit.log !== 'object' || Array.isArray(habit.log)) habit.log = {};
                if (!habit.log[today]) habit.log[today] = {};
                if (habit.log[today][habit.id]) delete habit.log[today][habit.id]; else habit.log[today][habit.id] = true;
                this.saveState();
                return habit;
            },

            renderStats() {
                const view = document.getElementById('stats-view');
                view.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">إحصائيات الإنجاز</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-secondary-bg p-4 rounded-lg shadow"><h3 class="font-bold text-lg mb-2">حالة المهام (مكتملة / غير مكتملة)</h3><canvas id="tasks-chart"></canvas></div>
                        <div class="bg-secondary-bg p-4 rounded-lg shadow"><h3 class="font-bold text-lg mb-2">إنجاز المهام حسب الفئة</h3><canvas id="categories-chart"></canvas></div>
                        <div class="bg-secondary-bg p-4 rounded-lg shadow lg:col-span-2"><h3 class="font-bold text-lg mb-2">الالتزام بالعادات (آخر 7 أيام)</h3><canvas id="habits-chart"></canvas></div>
                    </div>`;
                this.renderTasksChart();
                this.renderCategoriesChart();
                this.renderHabitsChart();
            },

            renderTasksChart() {
                const ctx = document.getElementById('tasks-chart').getContext('2d');
                const completedTasks = this.state.tasks.filter(t => t.completed).length;
                const incompleteTasks = this.state.tasks.filter(t => !t.completed).length;

                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['المهام المكتملة', 'المهام غير المكتملة'],
                        datasets: [{ data: [completedTasks, incompleteTasks], backgroundColor: ['rgba(16, 185, 129, 0.7)', 'rgba(239, 68, 68, 0.7)'], borderColor: ['rgba(16, 185, 129, 1)', 'rgba(239, 68, 68, 1)'], borderWidth: 1 }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'top' } } }
                });
            },
            
            renderCategoriesChart() {
                const ctx = document.getElementById('categories-chart').getContext('2d');
                const labels = this.state.categories.map(c => c.name);
                const data = this.state.categories.map(c => this.state.tasks.filter(t => t.completed && t.categoryId === c.id).length);
                new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ label: 'المهام حسب الفئة', data, backgroundColor: this.state.categories.map(c => c.color), hoverOffset: 4 }] } });
            },

            renderHabitsChart() {
                const ctx = document.getElementById('habits-chart').getContext('2d');
                // Filter only daily habits for this chart
                const dailyHabits = this.state.habits.filter(h => h.type === 'daily' || !h.type);
                const habitData = dailyHabits.map(habit => {
                    let totalPercentage = 0;
                    for (let i = 0; i < 7; i++) {
                        const date = new Date(); date.setDate(date.getDate() - i);
                        const dateString = date.toISOString().split('T')[0];
                        const dayLog = habit.log && habit.log[dateString] ? habit.log[dateString] : null;
                        if (dayLog) {
                            if (habit.subHabits.length > 0) {
                                totalPercentage += (Object.keys(dayLog).length / habit.subHabits.length) * 100;
                            } else if (dayLog[habit.id]) {
                                totalPercentage += 100;
                            }
                        }
                    }
                    return { label: habit.title, percentage: totalPercentage / 7 };
                });
                new Chart(ctx, { type: 'bar', data: { labels: habitData.map(h => h.label), datasets: [{ label: 'متوسط الالتزام الأسبوعي (%)', data: habitData.map(h => h.percentage), backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: 'rgba(16, 185, 129, 1)', borderWidth: 1 }] }, options: { indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100 } } } });
            },

            renderSettings() {
                const view = document.getElementById('settings-view');
                view.innerHTML = `
                    <h2 class="text-2xl font-bold mb-6">الإعدادات</h2>
                    <div class="space-y-6">
                        <div class="bg-secondary-bg p-4 rounded-lg shadow">
                            <h3 class="font-bold text-lg mb-3">المظهر</h3>
                            <div class="flex items-center justify-between">
                                <span>الوضع الليلي</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="theme-toggle" class="sr-only peer" ${this.state.settings.theme === 'dark' ? 'checked' : ''}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>
                        <div class="bg-secondary-bg p-4 rounded-lg shadow">
                            <h3 class="font-bold text-lg mb-3">إدارة الفئات</h3>
                            <div id="categories-list" class="space-y-2 mb-4">${this.state.categories.map(c => `<div class="flex justify-between items-center p-2 bg-primary-bg rounded-lg" data-category-id="${c.id}"><div class="flex items-center gap-2"><span class="w-4 h-4 rounded-full" style="background-color: ${c.color};"></span><span>${c.name}</span></div><button class="delete-category-btn text-danger-color text-sm"><i class="fas fa-trash"></i></button></div>`).join('')}</div>
                            <form id="add-category-form" class="flex gap-2">
                                <input type="text" name="categoryName" placeholder="اسم الفئة الجديد" class="flex-grow bg-primary-bg border border-border-color rounded-lg px-3 py-2" required>
                                <input type="color" name="categoryColor" value="#3b82f6" class="bg-primary-bg rounded-lg">
                                <button type="submit" class="bg-accent-color text-accent-text px-4 py-2 rounded-lg">إضافة</button>
                            </form>
                        </div>
                        <div class="bg-secondary-bg p-4 rounded-lg shadow">
                            <h3 class="font-bold text-lg mb-3">النسخ الاحتياطي والاستعادة</h3>
                            <div class="flex gap-4">
                                <button id="export-data-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-download"></i> تصدير البيانات</button>
                                <button id="import-data-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2"><i class="fas fa-upload"></i> استيراد البيانات</button>
                                <input type="file" id="import-file-input" class="hidden" accept=".json">
                            </div>
                        </div>
                    </div>`;
                this.attachSettingsListeners();
            },

            attachSettingsListeners() {
                document.getElementById('theme-toggle').addEventListener('change', e => { this.state.settings.theme = e.target.checked ? 'dark' : 'light'; this.applyTheme(); this.saveState(); });
                document.getElementById('add-category-form').addEventListener('submit', e => { e.preventDefault(); const name = e.target.categoryName.value; const color = e.target.categoryColor.value; if (name) { this.addCategory(name, color); e.target.reset(); } });
                document.getElementById('categories-list').addEventListener('click', e => { const btn = e.target.closest('.delete-category-btn'); if (btn) { const categoryId = btn.closest('[data-category-id]').dataset.categoryId; this.showConfirmation('هل أنت متأكد؟ سيتم تعيين مهام هذه الفئة إلى "غير مصنف".', () => this.deleteCategory(parseInt(categoryId))); } });
                document.getElementById('export-data-btn').addEventListener('click', () => this.exportData());
                document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
                document.getElementById('import-file-input').addEventListener('change', e => this.importData(e));
            },

            addCategory(name, color) {
                const icons = ['fas fa-star', 'fas fa-heart', 'fas fa-book', 'fas fa-folder', 'fas fa-tag'];
                this.state.categories.push({ id: Date.now(), name, color, icon: icons[Math.floor(Math.random() * icons.length)] });
                this.saveState(); this.renderSettings();
            },

            deleteCategory(categoryId) {
                this.state.tasks.forEach(task => { if (task.categoryId === categoryId) task.categoryId = null; });
                this.state.categories = this.state.categories.filter(c => c.id !== categoryId);
                this.saveState(); this.renderSettings(); this.showToast('تم حذف الفئة.');
            },

            exportData() {
                const dataStr = JSON.stringify(this.state);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url; a.download = 'task-manager-backup.json'; a.click();
                URL.revokeObjectURL(url); this.showToast('تم تصدير البيانات.');
            },

            importData(event) {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedState = JSON.parse(e.target.result);
                        if (importedState.tasks && importedState.habits && importedState.categories) {
                            this.state = { ...this.state, ...importedState };
                            this.saveState(); this.render(); this.showToast('تم استيراد البيانات بنجاح.');
                        } else { throw new Error('Invalid file'); }
                    } catch (err) { this.showToast('فشل استيراد البيانات. ملف غير صالح.', 'error'); }
                };
                reader.readAsText(file);
            },

            applyTheme() {
                document.documentElement.classList.toggle('dark', this.state.settings.theme === 'dark');
            },

            showModal() {
                document.getElementById('modal-backdrop').classList.remove('hidden');
                document.getElementById('main-modal').classList.remove('hidden');
                document.getElementById('main-modal').addEventListener('click', this.handleModalClick.bind(this));
            },
            
            hideModal() {
                document.getElementById('modal-backdrop').classList.add('hidden');
                document.getElementById('main-modal').classList.add('hidden');
                document.getElementById('main-modal').removeEventListener('click', this.handleModalClick);
            },

            handleModalClick(e) { if (e.target.id === 'main-modal' || e.target.closest('.modal-close-btn')) this.hideModal(); },
            
            showConfirmation(message, onConfirm) {
                document.getElementById('confirm-message').textContent = message;
                const backdrop = document.getElementById('modal-backdrop');
                const dialog = document.getElementById('confirm-dialog');
                backdrop.classList.remove('hidden'); dialog.classList.remove('hidden');
                const confirmYes = document.getElementById('confirm-yes');
                const confirmNo = document.getElementById('confirm-no');
                const close = () => { backdrop.classList.add('hidden'); dialog.classList.add('hidden'); };
                confirmYes.onclick = () => { onConfirm(); close(); };
                confirmNo.onclick = close;
            },
            
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.querySelector('p').textContent = message;
                toast.className = toast.className.replace(/bg-\w+-500/, type === 'success' ? 'bg-green-500' : 'bg-red-500');
                toast.classList.remove('opacity-0', 'translate-y-20');
                setTimeout(() => toast.classList.add('opacity-0', 'translate-y-20'), 3000);
            },
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
    
</body>
</html>



